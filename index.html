<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JRE Keyword Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:       #0d0d1a;
  --surface:  #16213e;
  --card:     #1a1a2e;
  --border:   #2a2a4a;
  --accent:   #e94560;
  --accent2:  #00b4d8;
  --gold:     #ffd166;
  --green:    #06d6a0;
  --text:     #e8e8f0;
  --muted:    #888899;
  --radius:   10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

.app { display: flex; flex-direction: column; min-height: 100vh; }

header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.logo { font-size: 1.3rem; font-weight: 700; color: var(--accent); white-space: nowrap; }
.logo span { color: var(--text); }

.search-bar {
  display: flex;
  flex: 1;
  min-width: 260px;
  gap: 8px;
}
.search-bar input {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 16px;
  color: var(--text);
  font-size: 1rem;
  outline: none;
  transition: border-color .2s;
}
.search-bar input:focus { border-color: var(--accent2); }
.search-bar input::placeholder { color: var(--muted); }

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  font-size: .9rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity: .4; cursor: default; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-blue { background: var(--accent2); color: #000; }

.header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--muted);
  display: inline-block;
}
.status-dot.ok    { background: var(--green); }
.status-dot.busy  { background: var(--gold); animation: pulse 1s infinite; }
.status-dot.error { background: var(--accent); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

.status-text { font-size: .8rem; color: var(--muted); }

main { flex: 1; padding: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}
.card-title {
  font-size: .85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
  margin-bottom: 16px;
}

.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  text-align: center;
}
.stat-val { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
.stat-val.blue  { color: var(--accent2); }
.stat-val.gold  { color: var(--gold); }
.stat-val.green { color: var(--green); }
.stat-label { font-size: .75rem; color: var(--muted); margin-top: 4px; }

.avgs-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.avg-pill {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: .82rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
.avg-pill .n   { color: var(--muted); }
.avg-pill .v   { font-weight: 700; }
.avg-pill .raw { font-size: .72rem; color: var(--muted); margin-left: 4px; }
.avg-pill.ep1   .v { color: #fff; }
.avg-pill.ep5   .v { color: var(--accent2); }
.avg-pill.ep20  .v { color: #90e0ef; }
.avg-pill.ep50  .v { color: var(--gold); }
.avg-pill.ep100 .v { color: var(--green); }

.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-wrap { position: relative; height: 280px; }

.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .85rem; }
thead th {
  background: var(--surface);
  padding: 10px 12px;
  text-align: left;
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .1s;
}
tbody tr:hover { background: var(--surface); }
tbody tr.selected { background: #1e1e3a; }
tbody td { padding: 9px 12px; }
.count-badge {
  display: inline-block;
  background: var(--accent);
  color: #fff;
  border-radius: 4px;
  padding: 1px 7px;
  font-weight: 700;
  font-size: .82rem;
  min-width: 24px;
  text-align: center;
}
.count-badge.zero { background: var(--border); color: var(--muted); }
.ep-num { color: var(--accent2); font-weight: 600; }
.per-min { color: var(--muted); font-size: .8rem; }

.fv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
.fv-cell {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  text-align: center;
  transition: border-color .15s, transform .1s;
  cursor: default;
}
.fv-cell:hover { border-color: var(--accent2); transform: translateY(-2px); }
.fv-n { font-size: .75rem; color: var(--muted); margin-bottom: 4px; }
.fv-pct { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
.fv-pct.high   { color: var(--accent); }
.fv-pct.medium { color: var(--gold); }
.fv-pct.low    { color: var(--muted); }
.fv-label { font-size: .7rem; color: var(--muted); margin-top: 3px; }
.fv-model-badge, .fv-ref-badge {
  display: inline-block;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: .75rem;
  color: var(--accent2);
  margin-bottom: 14px;
}
.fv-ref-badge {
  color: var(--muted);
  margin-left: 6px;
}

.user-hidden { display: none !important; }

#minute-panel { display: none; }
#minute-panel.visible { display: block; }

.empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}
.empty .icon { font-size: 3rem; margin-bottom: 12px; }

.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px 32px;
  width: 420px;
  max-width: 95vw;
}
.modal h2 { margin-bottom: 16px; font-size: 1.1rem; }
.modal p { color: var(--muted); font-size: .9rem; margin-bottom: 20px; line-height: 1.6; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

.lookback-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.lookback-row label { font-size: .82rem; color: var(--muted); }
.lookback-row select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 5px 10px;
  font-size: .85rem;
  outline: none;
  cursor: pointer;
}

.toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 20px;
  font-size: .9rem;
  z-index: 200;
  transform: translateY(80px);
  opacity: 0;
  transition: all .3s;
  max-width: 340px;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error   { border-color: var(--accent); color: var(--accent); }

#landing { display: none; }
#landing.visible { display: block; }
#results { display: none; }
#results.visible { display: block; }

.demo-note {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent2);
  border-radius: var(--radius);
  padding: 10px 16px;
  font-size: .82rem;
  color: var(--muted);
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">JRE <span>Keyword Analyzer</span></div>

  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search keywordâ€¦ e.g. DMT, aliens, Trump" autocomplete="off"/>
    <button class="btn btn-primary" id="search-btn">Search</button>
  </div>

  <div class="header-actions">
    <span class="status-dot" id="status-dot"></span>
    <span class="status-text" id="status-text">Ready</span>
    <button class="btn btn-secondary" id="demo-btn">Load Demo</button>
    <button class="btn btn-blue" id="sync-btn">About Sync</button>
  </div>
</header>

<main>

  <div id="landing">
    <div class="empty">
      <div class="icon">ğŸ™ï¸</div>
      <h2 style="margin-bottom:10px">JRE Keyword Analyzer</h2>
      <p style="color:var(--muted);margin-bottom:8px">
        Type any keyword and hit <strong style="color:var(--text)">Search</strong> to generate synthetic episode data and see Polymarket-style fair values.
      </p>
      <p style="color:var(--muted);margin-bottom:24px;font-size:.85rem">
        Running in browser-only mode â€” data is procedurally generated per keyword.
      </p>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" id="landing-demo-btn">Try "DMT" Demo</button>
      </div>
    </div>
  </div>

  <div id="results">

    <div class="demo-note" id="demo-note">
      Browser demo mode â€” episode counts are procedurally generated from the keyword as a seed. Same keyword always gives the same data.
    </div>

    <div class="stats-row" id="stats-row" aria-hidden="true">
      <div class="stat-card">
        <div class="stat-val" id="stat-total">â€“</div>
        <div class="stat-label">Total mentions</div>
      </div>
      <div class="stat-card">
        <div class="stat-val blue" id="stat-episodes">â€“</div>
        <div class="stat-label">Episodes with data</div>
      </div>
      <div class="stat-card">
        <div class="stat-val gold" id="stat-avg1">â€“</div>
        <div class="stat-label">Avg/min last ep</div>
      </div>
      <div class="stat-card">
        <div class="stat-val green" id="stat-avg20">â€“</div>
        <div class="stat-label">Avg/min last 20 eps</div>
      </div>
    </div>

    <div class="avgs-row" id="avgs-row"></div>

    <div class="charts-grid">
      <div class="card user-hidden" aria-hidden="true">
        <div class="card-title">Mentions per episode</div>
        <div class="chart-wrap"><canvas id="trend-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Polymarket fair value â€” next episode</div>
        <div class="lookback-row">
          <label>Lookback:</label>
          <select id="lookback-sel">
            <option value="5">Last 5</option>
            <option value="10">Last 10</option>
            <option value="20" selected>Last 20</option>
            <option value="50">Last 50</option>
            <option value="100">Last 100</option>
          </select>
          <span id="fv-model-badge" class="fv-model-badge"></span>
          <span id="fv-ref-badge" class="fv-ref-badge" title="Normalized to median episode length of the lookback window"></span>
        </div>
        <div class="chart-wrap user-hidden" aria-hidden="true"><canvas id="fv-chart"></canvas></div>
      </div>
    </div>

    <div class="card user-hidden" aria-hidden="true">
      <div class="card-title">Fair value â€” P(â‰¥ N mentions) in next episode</div>
      <div class="fv-grid" id="fv-grid"></div>
    </div>

    <div class="card user-hidden" id="minute-panel" aria-hidden="true">
      <div class="card-title" id="minute-title">Per-minute breakdown</div>
      <div class="chart-wrap" style="height:220px"><canvas id="minute-chart"></canvas></div>
    </div>

  </div>
</main>
</div>

<!-- Sync info modal -->
<div class="modal-overlay" id="sync-modal">
  <div class="modal">
    <h2>YouTube Sync</h2>
    <p>
      Live YouTube sync requires the local Flask server (<code>python server.py</code>).
      It fetches real JRE transcripts from the PowerfulJRE channel and stores them in a local SQLite database.
    </p>
    <p>
      This GitHub Pages version runs entirely in your browser using procedurally generated data.
      Type any keyword in the search bar and hit <strong>Search</strong> â€” the same keyword always produces the same synthetic episode history.
    </p>
    <div class="modal-actions">
      <button class="btn btn-primary" id="sync-close">Got it</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ Seeded PRNG (mulberry32) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hashSeed(str) {
  let h = 0x9e3779b9 | 0;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 0x85ebca6b | 0);
    h ^= h >>> 13;
  }
  return h >>> 0;
}

function mulberry32(seed) {
  let a = seed >>> 0;
  return function() {
    a = (a + 0x6D2B79F5) | 0;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function gaussRand(rand) {
  let u = 0, v = 0;
  while (u === 0) u = rand();
  while (v === 0) v = rand();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// â”€â”€ Episode generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateEpisodes(keyword, n = 100) {
  const seed = hashSeed((keyword || 'dmt').toLowerCase().trim());
  const rand = mulberry32(seed);

  const episodes = [];
  for (let i = 0; i < n; i++) {
    const epNum = 2200 - i;
    const spike  = rand() < 0.08;
    let count;
    if (spike) {
      count = 8 + Math.floor(rand() * 13);
    } else {
      count = Math.max(0, Math.round(3.0 + gaussRand(rand) * Math.sqrt(3.0)));
    }
    const dur = 120 + Math.floor(rand() * 121);
    const d = new Date(2025, 0, 15);
    d.setDate(d.getDate() - i * 7);
    episodes.push({
      video_id:         `demo_${String(epNum).padStart(4, '0')}`,
      title:            `Joe Rogan Experience #${epNum}`,
      upload_date:      d.toISOString().slice(0, 10),
      episode_number:   epNum,
      duration_seconds: dur * 60,
      count,
      per_minute:       +(count / dur).toFixed(4),
    });
  }
  return episodes;
}

// â”€â”€ Averages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcAverages(episodes) {
  function avg(n) {
    const s = episodes.slice(0, n);
    if (!s.length) return null;
    return s.reduce((a, b) => a + b.count, 0) / s.length;
  }
  function avgPm(n) {
    const s = episodes.slice(0, n).filter(e => e.duration_seconds > 0);
    if (!s.length) return null;
    return s.reduce((a, b) => a + b.per_minute, 0) / s.length;
  }
  return {
    last_1:   avg(1),   last_5:   avg(5),   last_20:  avg(20),
    last_50:  avg(50),  last_100: avg(100),
    pm_last_1:   avgPm(1),   pm_last_5:   avgPm(5),   pm_last_20:  avgPm(20),
    pm_last_50:  avgPm(50),  pm_last_100: avgPm(100),
  };
}

// â”€â”€ Fair value (Poisson + Empirical) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_BUCKET = 15;

function poissonPMF(k, lambda) {
  if (lambda <= 0) return k === 0 ? 1 : 0;
  let logP = -lambda + k * Math.log(lambda);
  for (let i = 1; i <= k; i++) logP -= Math.log(i);
  return Math.exp(logP);
}

function poissonSF(k, lambda) {
  let cdf = 0;
  for (let i = 0; i < k; i++) cdf += poissonPMF(i, lambda);
  return Math.max(0, Math.min(1, 1 - cdf));
}

function empiricalSF(counts, k) {
  if (!counts.length) return k === 0 ? 1 : 0;
  return counts.filter(c => c >= k).length / counts.length;
}

function calcFairValue(episodes, lookback = 20) {
  // Normalize by episode duration: use per-minute rate Ã— median episode length
  // so episodes of different lengths are compared on equal footing.
  const recent = episodes.slice(0, lookback).filter(e => e.duration_seconds > 0);
  const fallback = episodes.slice(0, lookback); // in case no duration data

  let counts, intCounts, refMinutes;
  if (recent.length) {
    const durs = recent.map(e => e.duration_seconds).sort((a, b) => a - b);
    refMinutes = durs[Math.floor(durs.length / 2)] / 60;
    counts    = recent.map(e => e.per_minute * refMinutes);
    intCounts = counts.map(c => Math.max(0, Math.round(c)));
  } else {
    refMinutes = null;
    counts    = fallback.map(e => e.count);
    intCounts = counts.map(c => Math.round(c));
  }

  const n    = counts.length || 1;
  const mean = counts.reduce((a, b) => a + b, 0) / n;
  const variance = counts.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
  const model = n >= 10 ? 'empirical' : 'poisson';

  const buckets = [];
  for (let k = 0; k <= MAX_BUCKET; k++) {
    const sf = model === 'empirical' ? empiricalSF(intCounts, k) : poissonSF(k, mean);
    buckets.push({
      n: k, label: k === MAX_BUCKET ? `${k}+` : String(k), sf, pct: +(sf * 100).toFixed(2),
    });
  }

  return {
    lambda:            +mean.toFixed(4),
    mean:              +mean.toFixed(4),
    std_dev:           +Math.sqrt(variance).toFixed(4),
    model,
    lookback_episodes: n,
    reference_minutes: refMinutes ? +refMinutes.toFixed(1) : null,
    buckets,
  };
}

// â”€â”€ Per-minute breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateMinutes(episode, keyword) {
  if (episode.count === 0) return [];
  const seed = hashSeed((keyword + episode.video_id).toLowerCase());
  const rand = mulberry32(seed);
  const durMin = Math.floor(episode.duration_seconds / 60);
  const mins = [];
  for (let i = 0; i < episode.count; i++) mins.push(Math.floor(rand() * durMin));
  const minM = Math.min(...mins), maxM = Math.max(...mins);
  const map = {};
  for (const m of mins) map[m] = (map[m] || 0) + 1;
  const result = [];
  for (let m = minM; m <= maxM; m++) result.push({ minute: m, count: map[m] || 0 });
  return result;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentKeyword = "";
let allEpisodes    = null;
let currentData    = null;
let trendChart     = null;
let fvChart        = null;
let minuteChart    = null;

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("landing").classList.add("visible");

  document.getElementById("search-btn").addEventListener("click", doSearch);
  document.getElementById("search-input").addEventListener("keydown", e => {
    if (e.key === "Enter") doSearch();
  });

  document.getElementById("demo-btn").addEventListener("click", loadDemo);
  document.getElementById("landing-demo-btn").addEventListener("click", loadDemo);

  document.getElementById("sync-btn").addEventListener("click", () =>
    document.getElementById("sync-modal").classList.add("open")
  );
  document.getElementById("sync-close").addEventListener("click", () =>
    document.getElementById("sync-modal").classList.remove("open")
  );

  document.getElementById("lookback-sel").addEventListener("change", () => {
    if (currentKeyword && allEpisodes) updateFV();
  });
});

// â”€â”€ Demo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDemo() {
  document.getElementById("search-input").value = "dmt";
  doSearch();
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSearch() {
  const kw = document.getElementById("search-input").value.trim();
  if (!kw) { toast("Enter a keyword first", "error"); return; }

  if (kw !== currentKeyword || !allEpisodes) {
    allEpisodes    = generateEpisodes(kw, 100);
    currentKeyword = kw;
  }

  const lookback = parseInt(document.getElementById("lookback-sel").value);
  const averages  = calcAverages(allEpisodes);
  const fv        = calcFairValue(allEpisodes, lookback);

  currentData = { keyword: kw, episodes: allEpisodes, averages, fair_value: fv };

  renderResults(currentData);

  document.getElementById("status-dot").className  = "status-dot ok";
  document.getElementById("status-text").textContent =
    `100 episodes  |  keyword: "${kw}"`;

  document.getElementById("results").classList.add("visible");
  document.getElementById("landing").classList.remove("visible");
}

// â”€â”€ Update FV only (lookback change) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFV() {
  const lookback = parseInt(document.getElementById("lookback-sel").value);
  const fv = calcFairValue(allEpisodes, lookback);
  currentData.fair_value = fv;
  document.getElementById("fv-model-badge").textContent =
    { poisson: "Poisson", empirical: "Empirical", "neg-binomial": "Neg-Binomial" }[fv.model] || fv.model;
  const refElU = document.getElementById("fv-ref-badge");
  if (refElU) refElU.textContent = fv.reference_minutes ? `ref ${fv.reference_minutes}min` : "";
  renderFVChart(fv);
  renderFVGrid(fv);
}

// â”€â”€ Render all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(data) {
  const { episodes: eps, averages: avgs, fair_value: fv } = data;

  const total = eps.reduce((s, e) => s + e.count, 0);
  document.getElementById("stat-total").textContent    = total;
  document.getElementById("stat-episodes").textContent = eps.length;
  // Prefer per-minute values for the normalized view; fall back to raw counts
  const pm = avgs.pm_last_1   != null ? avgs : null;
  const fmtPm = v => v == null ? "â€“" : v.toFixed(3) + "/min";

  document.getElementById("stat-avg1").textContent  = fmtPm(avgs.pm_last_1);
  document.getElementById("stat-avg20").textContent = fmtPm(avgs.pm_last_20);

  const pillDefs = [
    { cls: "ep1",   n: "Last 1",   pm: avgs.pm_last_1,   raw: avgs.last_1   },
    { cls: "ep5",   n: "Last 5",   pm: avgs.pm_last_5,   raw: avgs.last_5   },
    { cls: "ep20",  n: "Last 20",  pm: avgs.pm_last_20,  raw: avgs.last_20  },
    { cls: "ep50",  n: "Last 50",  pm: avgs.pm_last_50,  raw: avgs.last_50  },
    { cls: "ep100", n: "Last 100", pm: avgs.pm_last_100, raw: avgs.last_100 },
  ];
  document.getElementById("avgs-row").innerHTML = pillDefs.map(p =>
    `<div class="avg-pill ${p.cls}">
       <span class="n">${p.n}:</span>
       <span class="v">${fmtPm(p.pm)}</span>
       <span class="raw">(${fmt(p.raw)} raw)</span>
     </div>`
  ).join("");

  renderTrendChart(eps, avgs);

  document.getElementById("fv-model-badge").textContent =
    { poisson: "Poisson", empirical: "Empirical", "neg-binomial": "Neg-Binomial" }[fv.model] || fv.model;
  const refEl = document.getElementById("fv-ref-badge");
  refEl.textContent = fv.reference_minutes ? `ref ${fv.reference_minutes}min` : "";
  renderFVChart(fv);
  renderFVGrid(fv);
  renderTable(eps);

  document.getElementById("minute-panel").classList.remove("visible");
  if (minuteChart) { minuteChart.destroy(); minuteChart = null; }
}

// â”€â”€ Trend chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrendChart(episodes, avgs) {
  const ctx = document.getElementById("trend-chart").getContext("2d");
  if (trendChart) trendChart.destroy();

  const eps    = [...episodes].reverse();
  const labels = eps.map(e => `#${e.episode_number}`);
  const counts = eps.map(e => e.count);

  const avgLines = [
    { label: "Last 1",   value: avgs.last_1,   color: "#ffffff" },
    { label: "Last 5",   value: avgs.last_5,   color: "#00b4d8" },
    { label: "Last 20",  value: avgs.last_20,  color: "#90e0ef" },
    { label: "Last 50",  value: avgs.last_50,  color: "#ffd166" },
    { label: "Last 100", value: avgs.last_100, color: "#06d6a0" },
  ].filter(a => a.value !== null && a.value !== undefined);

  trendChart = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        {
          label: "Mentions",
          data: counts,
          backgroundColor: counts.map(c => c > 0 ? "#e94560cc" : "#2a2a4a"),
          borderColor:     counts.map(c => c > 0 ? "#e94560"   : "#2a2a4a"),
          borderWidth: 1,
          borderRadius: 3,
          type: "bar",
          order: 2,
        },
        ...avgLines.map(a => ({
          label:       `${a.label} avg: ${a.value.toFixed(2)}`,
          data:        Array(eps.length).fill(a.value),
          borderColor: a.color,
          borderWidth: 1.5,
          borderDash:  [4, 4],
          pointRadius: 0,
          type:        "line",
          order:       1,
        })),
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: {
          labels: { color: "#aaa", font: { size: 11 }, boxWidth: 18, padding: 10 },
          position: "top",
        },
        tooltip: {
          callbacks: {
            title: items => {
              const ep = eps[items[0].dataIndex];
              return ep.title ? ep.title.slice(0, 50) : labels[items[0].dataIndex];
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: "#888", maxRotation: 45, font: { size: 10 }, maxTicksLimit: 25 },
          grid:  { color: "#22223a" },
        },
        y: {
          ticks:       { color: "#888" },
          grid:        { color: "#22223a" },
          beginAtZero: true,
        }
      }
    }
  });
}

// â”€â”€ FV chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFVChart(fv) {
  const ctx = document.getElementById("fv-chart").getContext("2d");
  if (fvChart) fvChart.destroy();

  const labels = fv.buckets.map(b => b.label);
  const pcts   = fv.buckets.map(b => b.pct);
  const colors = fv.buckets.map(b => b.n === 0 ? "#0f3460" : "#e94560cc");

  fvChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "P(â‰¥ N) %",
        data:  pcts,
        backgroundColor: colors,
        borderColor:     colors.map(c => c.replace("cc", "")),
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: item => `P(â‰¥${item.label}) = ${item.raw.toFixed(1)}%`
          }
        }
      },
      scales: {
        x: { ticks: { color: "#888" }, grid: { color: "#22223a" } },
        y: {
          ticks:       { color: "#888", callback: v => v + "%" },
          grid:        { color: "#22223a" },
          beginAtZero: true,
          max: 100,
        }
      }
    }
  });
}

// â”€â”€ FV grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFVGrid(fv) {
  document.getElementById("fv-grid").innerHTML = fv.buckets.map(b => {
    const cls = b.pct >= 30 ? "high" : b.pct >= 10 ? "medium" : "low";
    return `<div class="fv-cell">
      <div class="fv-n">â‰¥ ${b.label} mention${b.n !== 1 ? "s" : ""}</div>
      <div class="fv-pct ${cls}">${b.pct.toFixed(1)}%</div>
      <div class="fv-label">P(mentions â‰¥ ${b.label})</div>
    </div>`;
  }).join("");
}

// â”€â”€ Episode table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(episodes) {
  const tbody = document.getElementById("ep-tbody");
  if (!tbody) return;
  tbody.innerHTML = episodes.map(ep => {
    const badge = ep.count > 0
      ? `<span class="count-badge">${ep.count}</span>`
      : `<span class="count-badge zero">0</span>`;
    const pm = ep.per_minute > 0 ? `<span class="per-min">${ep.per_minute.toFixed(3)}/min</span>` : "";
    const title = (ep.title || "").slice(0, 55) + ((ep.title || "").length > 55 ? "â€¦" : "");
    return `<tr data-vid="${ep.video_id}">
      <td class="ep-num">#${ep.episode_number}</td>
      <td>${ep.upload_date}</td>
      <td>${badge}</td>
      <td>${pm}</td>
      <td>${title}</td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("tr").forEach(row => {
    row.addEventListener("click", () => {
      tbody.querySelectorAll("tr").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      loadMinutes(row.dataset.vid);
    });
  });
}

// â”€â”€ Per-minute breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadMinutes(videoId) {
  if (!currentKeyword || !allEpisodes) return;
  const ep = allEpisodes.find(e => e.video_id === videoId);
  if (!ep) return;

  const minutes = generateMinutes(ep, currentKeyword);
  const panel   = document.getElementById("minute-panel");
  panel.classList.add("visible");
  document.getElementById("minute-title").textContent =
    `Per-minute â€” ${ep.title.slice(0, 60)}`;

  const ctx = document.getElementById("minute-chart").getContext("2d");
  if (minuteChart) minuteChart.destroy();

  if (!minutes.length) {
    panel.querySelector("canvas").style.display = "none";
    document.getElementById("minute-title").textContent += "  (no mentions)";
    return;
  }
  panel.querySelector("canvas").style.display = "";

  const labels = minutes.map(m => `${m.minute}m`);
  const counts = minutes.map(m => m.count);
  const mean   = counts.reduce((a, b) => a + b, 0) / counts.length;

  minuteChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Mentions",
          data:  counts,
          backgroundColor: "#e94560cc",
          borderColor:     "#e94560",
          borderWidth: 1,
          borderRadius: 3,
          order: 2,
        },
        {
          label:       `Avg ${mean.toFixed(2)}/min`,
          data:        Array(counts.length).fill(mean),
          type:        "line",
          borderColor: "#ffd166",
          borderWidth: 1.5,
          borderDash:  [4, 4],
          pointRadius: 0,
          order: 1,
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 200 },
      plugins: {
        legend: { labels: { color: "#aaa", font: { size: 10 }, boxWidth: 14 } }
      },
      scales: {
        x: {
          ticks: { color: "#888", font: { size: 10 }, maxTicksLimit: 30 },
          grid:  { color: "#22223a" },
        },
        y: {
          ticks:       { color: "#888" },
          grid:        { color: "#22223a" },
          beginAtZero: true,
        }
      }
    }
  });

  panel.scrollIntoView({ behavior: "smooth", block: "start" });
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v) {
  if (v === null || v === undefined) return "â€“";
  return Number(v).toFixed(2);
}

function toast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = `toast${type ? " " + type : ""}`;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove("show"), 3200);
}
</script>
</body>
</html>
