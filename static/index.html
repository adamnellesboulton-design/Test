<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JRE Keyword Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:       #0d0d1a;
  --surface:  #16213e;
  --card:     #1a1a2e;
  --border:   #2a2a4a;
  --accent:   #e94560;
  --accent2:  #00b4d8;
  --gold:     #ffd166;
  --green:    #06d6a0;
  --text:     #e8e8f0;
  --muted:    #888899;
  --radius:   10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* â”€â”€ Layout â”€â”€ */
.app { display: flex; flex-direction: column; min-height: 100vh; }

header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.logo { font-size: 1.3rem; font-weight: 700; color: var(--accent); white-space: nowrap; }
.logo span { color: var(--text); }

.search-bar {
  display: flex;
  flex: 1;
  min-width: 260px;
  gap: 8px;
}
.search-bar input {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 16px;
  color: var(--text);
  font-size: 1rem;
  outline: none;
  transition: border-color .2s;
}
.search-bar input:focus { border-color: var(--accent2); }
.search-bar input::placeholder { color: var(--muted); }

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  font-size: .9rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity: .4; cursor: default; }
.btn-primary   { background: var(--accent); color: #fff; }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-blue      { background: var(--accent2); color: #000; }
.btn-danger    { background: #3a1a1a; color: var(--accent); border: 1px solid var(--accent); font-size: .8rem; padding: 5px 10px; }
.btn-sm        { padding: 6px 12px; font-size: .8rem; }

.header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.status-text { font-size: .85rem; color: var(--muted); }

/* â”€â”€ Main â”€â”€ */
.main-cols {
  display: flex;
  flex: 1;
  gap: 0;
  min-height: 0;
}

/* â”€â”€ Sidebar (episodes) â”€â”€ */
.sidebar {
  width: 320px;
  min-width: 280px;
  max-width: 380px;
  background: var(--card);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}
.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.sidebar-title {
  font-size: .85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
}
.sidebar-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.episode-count {
  font-size: .8rem;
  color: var(--muted);
  padding: 0 16px 10px;
}
.episode-list {
  overflow-y: auto;
  flex: 1;
  padding: 8px 0;
}
.ep-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .1s;
}
.ep-item:hover { background: var(--surface); }
.ep-item input[type=checkbox] {
  accent-color: var(--accent2);
  width: 16px; height: 16px;
  flex-shrink: 0;
  cursor: pointer;
}
.ep-info { flex: 1; min-width: 0; }
.ep-title {
  font-size: .83rem;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.ep-meta {
  font-size: .72rem;
  color: var(--muted);
  margin-top: 2px;
}
.ep-delete {
  opacity: 0;
  transition: opacity .15s;
  flex-shrink: 0;
}
.ep-item:hover .ep-delete { opacity: 1; }

.select-all-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  font-size: .8rem;
  color: var(--muted);
}
.select-all-row input[type=checkbox] {
  accent-color: var(--accent2);
  width: 15px; height: 15px;
  cursor: pointer;
}

/* â”€â”€ Upload panel â”€â”€ */
.upload-panel {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  z-index: 100;
  align-items: center;
  justify-content: center;
}
.upload-panel.visible { display: flex; }
.upload-box {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 28px;
  width: 520px;
  max-width: 96vw;
  max-height: 90vh;
  overflow-y: auto;
}
.upload-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 18px;
  color: var(--text);
}
.upload-drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 32px 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  margin-bottom: 16px;
}
.upload-drop-zone:hover,
.upload-drop-zone.drag-over {
  border-color: var(--accent2);
  background: rgba(0,180,216,.05);
}
.upload-drop-zone .icon { font-size: 2rem; margin-bottom: 8px; }
.upload-drop-zone p { color: var(--muted); font-size: .9rem; }
.upload-drop-zone strong { color: var(--accent2); cursor: pointer; }
#file-input { display: none; }

/* Queued files list */
.queued-files { margin-bottom: 16px; }
.queued-file {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  margin-bottom: 8px;
}
.queued-file-name { font-size: .85rem; font-weight: 600; margin-bottom: 6px; }
.field-row {
  display: flex;
  gap: 8px;
  margin-bottom: 0;
}
.field-row input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 10px;
  color: var(--text);
  font-size: .82rem;
  outline: none;
}
.field-row input:focus { border-color: var(--accent2); }
.field-row input::placeholder { color: var(--muted); }
.field-row .date-input { flex: 0 0 130px; }

.upload-actions { display: flex; gap: 10px; justify-content: flex-end; }
.upload-progress { font-size: .85rem; color: var(--accent2); margin-top: 12px; }
.upload-result-item { font-size: .8rem; margin-top: 4px; }
.upload-result-item.ok    { color: var(--green); }
.upload-result-item.error { color: var(--accent); }

/* â”€â”€ Content area â”€â”€ */
.content { flex: 1; padding: 24px; overflow-y: auto; min-width: 0; }

/* â”€â”€ Cards â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}
.card-title {
  font-size: .85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
  margin-bottom: 16px;
}

/* â”€â”€ Stats row â”€â”€ */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  text-align: center;
}
.stat-val { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
.stat-val.blue  { color: var(--accent2); }
.stat-val.gold  { color: var(--gold); }
.stat-val.green { color: var(--green); }
.stat-label { font-size: .75rem; color: var(--muted); margin-top: 4px; }

/* â”€â”€ Averages row â”€â”€ */
.avgs-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.avg-pill {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: .82rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
.avg-pill .n { color: var(--muted); }
.avg-pill .v { font-weight: 700; }
.avg-pill.ep1   .v { color: #fff; }
.avg-pill.ep5   .v { color: var(--accent2); }
.avg-pill.ep20  .v { color: #90e0ef; }
.avg-pill.ep50  .v { color: var(--gold); }
.avg-pill.ep100 .v { color: var(--green); }

/* â”€â”€ Charts grid â”€â”€ */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-wrap { position: relative; height: 280px; }

/* â”€â”€ Table â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .85rem; }
thead th {
  background: var(--surface);
  padding: 10px 12px;
  text-align: left;
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .1s;
}
tbody tr:hover { background: var(--surface); }
tbody tr.selected { background: #1e1e3a; }
tbody td { padding: 9px 12px; }
.count-badge {
  display: inline-block;
  background: var(--accent);
  color: #fff;
  border-radius: 4px;
  padding: 1px 7px;
  font-weight: 700;
  font-size: .82rem;
  min-width: 24px;
  text-align: center;
}
.count-badge.zero { background: var(--border); color: var(--muted); }
.ep-num { color: var(--accent2); font-weight: 600; }
.per-min { color: var(--muted); font-size: .8rem; }

/* â”€â”€ Fair value table â”€â”€ */
.fv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
.fv-cell {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  text-align: center;
  transition: border-color .15s, transform .1s;
  cursor: default;
}
.fv-cell:hover { border-color: var(--accent2); transform: translateY(-2px); }
.fv-n { font-size: .75rem; color: var(--muted); margin-bottom: 4px; }
.fv-pct { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
.fv-pct.high   { color: var(--accent); }
.fv-pct.medium { color: var(--gold); }
.fv-pct.low    { color: var(--muted); }
.fv-label { font-size: .7rem; color: var(--muted); margin-top: 3px; }
.fv-model-badge {
  display: inline-block;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: .75rem;
  color: var(--accent2);
  margin-bottom: 14px;
}

/* â”€â”€ Per-minute panel â”€â”€ */
#minute-panel { display: none; }
#minute-panel.visible { display: block; }

/* â”€â”€ Empty / loading states â”€â”€ */
.empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}
.empty .icon { font-size: 3rem; margin-bottom: 12px; }
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent2);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Lookback selector â”€â”€ */
.lookback-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.lookback-row label { font-size: .82rem; color: var(--muted); }
.lookback-row select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 5px 10px;
  font-size: .85rem;
  outline: none;
  cursor: pointer;
}

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 20px;
  font-size: .9rem;
  z-index: 200;
  transform: translateY(80px);
  opacity: 0;
  transition: all .3s;
  max-width: 320px;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error   { border-color: var(--accent); color: var(--accent); }

/* â”€â”€ Results visibility â”€â”€ */
#no-data-msg { display: none; }
#no-data-msg.visible { display: block; }
#results { display: none; }
#results.visible { display: block; }

/* â”€â”€ Responsive â”€â”€ */
@media (max-width: 720px) {
  .main-cols { flex-direction: column; }
  .sidebar { width: 100%; max-width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 260px; }
}
</style>
</head>
<body>
<div class="app">

<!-- â”€â”€ Header â”€â”€ -->
<header>
  <div class="logo">JRE <span>Keyword Analyzer</span></div>

  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search keywordâ€¦ e.g. DMT, aliens, Trump" autocomplete="off"/>
    <button class="btn btn-primary" id="search-btn">Search</button>
  </div>

  <div class="header-actions">
    <span class="status-text" id="status-text">Loadingâ€¦</span>
  </div>
</header>

<!-- â”€â”€ Body â”€â”€ -->
<div class="main-cols">

  <!-- â”€â”€ Sidebar: Episodes â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Episodes</div>
      <div class="sidebar-actions">
        <button class="btn btn-blue btn-sm" id="upload-btn">+ Upload</button>
        <button class="btn btn-secondary btn-sm" id="search-selected-btn">Search selected</button>
      </div>
    </div>

    <div class="select-all-row">
      <input type="checkbox" id="select-all-cb" title="Select / deselect all"/>
      <label for="select-all-cb" style="cursor:pointer">Select all</label>
      <span id="selected-count" style="margin-left:auto;color:var(--accent2)"></span>
    </div>

    <div class="episode-count" id="episode-count"></div>
    <div class="episode-list" id="episode-list">
      <div class="empty" style="padding:30px 20px">
        <div class="icon">ğŸ“‚</div>
        <p>No episodes yet.<br>Upload .txt transcripts to get started.</p>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ Content â”€â”€ -->
  <main class="content">

    <!-- No data -->
    <div id="no-data-msg">
      <div class="empty">
        <div class="icon">ğŸ”</div>
        <h2 style="margin-bottom:10px">Upload transcripts to begin</h2>
        <p style="color:var(--muted)">Click <strong>+ Upload</strong> in the sidebar to add .txt transcript files,<br>then search for any keyword.</p>
      </div>
    </div>

    <!-- Results -->
    <div id="results">

      <!-- Stats row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-val" id="stat-total">â€“</div>
          <div class="stat-label">Total mentions</div>
        </div>
        <div class="stat-card">
          <div class="stat-val blue" id="stat-episodes">â€“</div>
          <div class="stat-label">Episodes searched</div>
        </div>
        <div class="stat-card">
          <div class="stat-val gold" id="stat-avg1">â€“</div>
          <div class="stat-label">Avg last episode</div>
        </div>
        <div class="stat-card">
          <div class="stat-val green" id="stat-avg20">â€“</div>
          <div class="stat-label">Avg last 20 eps</div>
        </div>
      </div>

      <!-- Averages pills -->
      <div class="avgs-row" id="avgs-row"></div>

      <!-- Charts grid -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-title">Mentions per episode</div>
          <div class="chart-wrap"><canvas id="trend-chart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-title">Polymarket fair value â€” next episode</div>
          <div class="lookback-row">
            <label>Lookback:</label>
            <select id="lookback-sel">
              <option value="5">Last 5</option>
              <option value="10">Last 10</option>
              <option value="20" selected>Last 20</option>
              <option value="50">Last 50</option>
              <option value="100">Last 100</option>
            </select>
            <span id="fv-model-badge" class="fv-model-badge"></span>
          </div>
          <div class="chart-wrap"><canvas id="fv-chart"></canvas></div>
        </div>
      </div>

      <!-- Fair value grid -->
      <div class="card">
        <div class="card-title">Fair value â€” P(â‰¥ N mentions) in next episode</div>
        <div class="fv-grid" id="fv-grid"></div>
      </div>

      <!-- Per-minute panel -->
      <div class="card" id="minute-panel">
        <div class="card-title" id="minute-title">Per-minute breakdown</div>
        <div class="chart-wrap" style="height:220px"><canvas id="minute-chart"></canvas></div>
      </div>

      <!-- Episode table -->
      <div class="card">
        <div class="card-title">Episode history â€” click a row for per-minute view</div>
        <div class="table-wrap">
          <table id="ep-table">
            <thead>
              <tr>
                <th>Episode</th>
                <th>Date</th>
                <th>Mentions</th>
                <th>Per min</th>
                <th>Title</th>
              </tr>
            </thead>
            <tbody id="ep-tbody"></tbody>
          </table>
        </div>
      </div>

    </div><!-- /results -->
  </main>
</div><!-- /main-cols -->
</div><!-- /app -->

<!-- â”€â”€ Upload panel â”€â”€ -->
<div class="upload-panel" id="upload-panel">
  <div class="upload-box">
    <div class="upload-title">Upload Transcripts</div>

    <div class="upload-drop-zone" id="drop-zone">
      <div class="icon">ğŸ“„</div>
      <p>Drag &amp; drop .txt files here<br>or <strong id="browse-link">browse</strong></p>
      <input type="file" id="file-input" accept=".txt" multiple/>
    </div>

    <div class="queued-files" id="queued-files"></div>

    <div class="upload-actions">
      <button class="btn btn-secondary" id="upload-cancel-btn">Cancel</button>
      <button class="btn btn-primary" id="upload-submit-btn" disabled>Upload</button>
    </div>

    <div id="upload-progress" class="upload-progress" style="display:none"></div>
    <div id="upload-results"></div>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€ -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allEpisodes   = [];   // [{id, title, episode_date, ...}]
let selectedIds   = new Set();  // episode IDs checked in sidebar
let currentData   = null;
let currentKeyword = "";
let trendChart    = null;
let fvChart       = null;
let minuteChart   = null;
let queuedFiles   = [];   // [{file, title, date}]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Boot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  loadEpisodes();

  document.getElementById("search-btn").addEventListener("click", doSearch);
  document.getElementById("search-input").addEventListener("keydown", e => {
    if (e.key === "Enter") doSearch();
  });
  document.getElementById("lookback-sel").addEventListener("change", () => {
    if (currentKeyword) doSearch();
  });

  // Sidebar
  document.getElementById("upload-btn").addEventListener("click", openUpload);
  document.getElementById("search-selected-btn").addEventListener("click", doSearch);
  document.getElementById("select-all-cb").addEventListener("change", toggleSelectAll);

  // Upload panel
  document.getElementById("upload-cancel-btn").addEventListener("click", closeUpload);
  document.getElementById("upload-submit-btn").addEventListener("click", submitUpload);
  document.getElementById("browse-link").addEventListener("click", () =>
    document.getElementById("file-input").click()
  );
  document.getElementById("drop-zone").addEventListener("click", e => {
    if (e.target.id !== "browse-link") document.getElementById("file-input").click();
  });
  document.getElementById("file-input").addEventListener("change", e =>
    addFiles(Array.from(e.target.files))
  );

  // Drag-and-drop
  const dz = document.getElementById("drop-zone");
  dz.addEventListener("dragover", e => { e.preventDefault(); dz.classList.add("drag-over"); });
  dz.addEventListener("dragleave", () => dz.classList.remove("drag-over"));
  dz.addEventListener("drop", e => {
    e.preventDefault();
    dz.classList.remove("drag-over");
    addFiles(Array.from(e.dataTransfer.files).filter(f => f.name.endsWith(".txt")));
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Load episodes from server
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEpisodes() {
  try {
    const r = await fetch("/api/episodes");
    allEpisodes = await r.json();
    // Default: all selected
    selectedIds = new Set(allEpisodes.map(e => e.id));
    renderSidebar();
    updateStatus();
  } catch {
    document.getElementById("status-text").textContent = "Server unreachable";
  }
}

function updateStatus() {
  const total = allEpisodes.length;
  document.getElementById("status-text").textContent =
    total === 0 ? "No episodes uploaded" : `${total} episode${total !== 1 ? "s" : ""} in database`;

  if (total === 0) {
    document.getElementById("no-data-msg").classList.add("visible");
    document.getElementById("results").classList.remove("visible");
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sidebar
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  const list = document.getElementById("episode-list");
  const countEl = document.getElementById("episode-count");

  if (allEpisodes.length === 0) {
    list.innerHTML = `<div class="empty" style="padding:30px 20px">
      <div class="icon">ğŸ“‚</div>
      <p>No episodes yet.<br>Upload .txt transcripts to get started.</p>
    </div>`;
    countEl.textContent = "";
    document.getElementById("selected-count").textContent = "";
    return;
  }

  countEl.textContent = `${allEpisodes.length} episode${allEpisodes.length !== 1 ? "s" : ""}`;
  updateSelectedCount();

  list.innerHTML = allEpisodes.map(ep => {
    const checked = selectedIds.has(ep.id) ? "checked" : "";
    const num = ep.episode_number ? `#${ep.episode_number} Â· ` : "";
    const date = ep.episode_date || ep.uploaded_at?.slice(0, 10) || "";
    const dur  = ep.duration_seconds > 0 ? ` Â· ${Math.round(ep.duration_seconds / 60)}m` : "";
    const title = (ep.title || "").slice(0, 45) + ((ep.title || "").length > 45 ? "â€¦" : "");
    return `<div class="ep-item" data-id="${ep.id}">
      <input type="checkbox" ${checked} data-id="${ep.id}" onclick="toggleEpisode(event,${ep.id})"/>
      <div class="ep-info">
        <div class="ep-title">${escHtml(title)}</div>
        <div class="ep-meta">${num}${date}${dur}</div>
      </div>
      <button class="btn btn-danger ep-delete" onclick="deleteEpisode(event,${ep.id})" title="Delete">âœ•</button>
    </div>`;
  }).join("");

  // Sync select-all checkbox
  const allChecked = allEpisodes.every(e => selectedIds.has(e.id));
  const noneChecked = allEpisodes.every(e => !selectedIds.has(e.id));
  const cb = document.getElementById("select-all-cb");
  cb.checked = allChecked;
  cb.indeterminate = !allChecked && !noneChecked;
}

function toggleEpisode(event, id) {
  event.stopPropagation();
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
  } else {
    selectedIds.add(id);
  }
  updateSelectedCount();
  // Sync select-all checkbox
  const allChecked = allEpisodes.every(e => selectedIds.has(e.id));
  const noneChecked = allEpisodes.every(e => !selectedIds.has(e.id));
  const cb = document.getElementById("select-all-cb");
  cb.checked = allChecked;
  cb.indeterminate = !allChecked && !noneChecked;
}

function toggleSelectAll() {
  const cb = document.getElementById("select-all-cb");
  if (cb.checked) {
    selectedIds = new Set(allEpisodes.map(e => e.id));
  } else {
    selectedIds = new Set();
  }
  renderSidebar();
}

function updateSelectedCount() {
  const n = selectedIds.size;
  const total = allEpisodes.length;
  document.getElementById("selected-count").textContent =
    n === total ? "" : `${n} selected`;
}

async function deleteEpisode(event, id) {
  event.stopPropagation();
  if (!confirm("Delete this episode and all its data?")) return;
  try {
    const r = await fetch(`/api/episode/${id}`, { method: "DELETE" });
    if (!r.ok) throw new Error("Delete failed");
    allEpisodes = allEpisodes.filter(e => e.id !== id);
    selectedIds.delete(id);
    renderSidebar();
    updateStatus();
    toast("Episode deleted", "success");
  } catch (e) {
    toast(e.message, "error");
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Upload panel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openUpload() {
  queuedFiles = [];
  document.getElementById("queued-files").innerHTML = "";
  document.getElementById("upload-submit-btn").disabled = true;
  document.getElementById("file-input").value = "";
  document.getElementById("upload-progress").style.display = "none";
  document.getElementById("upload-results").innerHTML = "";
  document.getElementById("upload-panel").classList.add("visible");
}

function closeUpload() {
  document.getElementById("upload-panel").classList.remove("visible");
}

function addFiles(files) {
  files.forEach(f => {
    if (!f.name.endsWith(".txt")) return;
    queuedFiles.push({ file: f, title: "" });
  });
  renderQueuedFiles();
  document.getElementById("upload-submit-btn").disabled = queuedFiles.length === 0;
}

function renderQueuedFiles() {
  const container = document.getElementById("queued-files");
  if (queuedFiles.length === 0) {
    container.innerHTML = "";
    return;
  }
  container.innerHTML = queuedFiles.map((item, i) => `
    <div class="queued-file" data-index="${i}">
      <div class="queued-file-name">ğŸ“„ ${escHtml(item.file.name)}</div>
      <div class="field-row">
        <input type="text"
               placeholder="Episode title (optional)"
               value="${escHtml(item.title)}"
               oninput="queuedFiles[${i}].title=this.value"/>
      </div>
    </div>
  `).join("");
}

async function submitUpload() {
  if (queuedFiles.length === 0) return;

  const btn = document.getElementById("upload-submit-btn");
  const prog = document.getElementById("upload-progress");
  const resultsEl = document.getElementById("upload-results");

  btn.disabled = true;
  prog.style.display = "block";
  prog.textContent = `Uploading ${queuedFiles.length} file(s)â€¦`;
  resultsEl.innerHTML = "";

  const fd = new FormData();
  queuedFiles.forEach(item => {
    fd.append("files[]", item.file, item.file.name);
    fd.append("title[]", item.title || item.file.name.replace(/\.txt$/i, ""));
  });

  try {
    const r = await fetch("/api/upload", { method: "POST", body: fd });
    const data = await r.json();

    let html = "";
    (data.created || []).forEach(ep => {
      html += `<div class="upload-result-item ok">âœ“ ${escHtml(ep.title)} â€” ${ep.segment_count} segments</div>`;
    });
    (data.errors || []).forEach(err => {
      html += `<div class="upload-result-item error">âœ— ${escHtml(err.filename)}: ${escHtml(err.error)}</div>`;
    });
    resultsEl.innerHTML = html;

    prog.textContent = `Done. ${(data.created||[]).length} uploaded, ${(data.errors||[]).length} errors.`;

    if ((data.created || []).length > 0) {
      await loadEpisodes();
      toast(`${data.created.length} episode(s) uploaded`, "success");
    }

    queuedFiles = [];
    btn.disabled = true;
  } catch (e) {
    prog.textContent = "Upload failed: " + e.message;
    toast("Upload failed", "error");
    btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Search
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSearch() {
  const kw = document.getElementById("search-input").value.trim();
  if (!kw) { toast("Enter a keyword first", "error"); return; }
  if (allEpisodes.length === 0) { toast("Upload transcripts first", "error"); return; }

  const lookback = document.getElementById("lookback-sel").value;
  currentKeyword = kw;

  // Determine episode filter
  const allSelected = selectedIds.size === allEpisodes.length;
  const episodeIdsParam = allSelected
    ? ""
    : Array.from(selectedIds).join(",");

  if (selectedIds.size === 0) { toast("Select at least one episode", "error"); return; }

  const btn = document.getElementById("search-btn");
  btn.disabled = true;
  btn.textContent = "Searchingâ€¦";

  try {
    let url = `/api/search?keyword=${encodeURIComponent(kw)}&lookback=${lookback}`;
    if (episodeIdsParam) url += `&episode_ids=${episodeIdsParam}`;

    const r = await fetch(url);
    if (!r.ok) { const e = await r.json(); throw new Error(e.error || r.statusText); }
    const data = await r.json();
    currentData = data;
    renderResults(data);
    document.getElementById("results").classList.add("visible");
    document.getElementById("no-data-msg").classList.remove("visible");
  } catch (e) {
    toast(e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Search";
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(data) {
  const eps  = data.episodes;
  const avgs = data.averages;
  const fv   = data.fair_value;

  const total = eps.reduce((s, e) => s + e.count, 0);
  document.getElementById("stat-total").textContent    = total;
  document.getElementById("stat-episodes").textContent = eps.length;
  document.getElementById("stat-avg1").textContent     = fmt(avgs.last_1);
  document.getElementById("stat-avg20").textContent    = fmt(avgs.last_20);

  // Average pills
  const pillDefs = [
    {cls:"ep1",   n:"Last 1",   v: avgs.last_1},
    {cls:"ep5",   n:"Last 5",   v: avgs.last_5},
    {cls:"ep20",  n:"Last 20",  v: avgs.last_20},
    {cls:"ep50",  n:"Last 50",  v: avgs.last_50},
    {cls:"ep100", n:"Last 100", v: avgs.last_100},
  ];
  document.getElementById("avgs-row").innerHTML = pillDefs.map(p =>
    `<div class="avg-pill ${p.cls}">
       <span class="n">${p.n}:</span>
       <span class="v">${fmt(p.v)}</span>
     </div>`
  ).join("");

  renderTrendChart(eps);

  document.getElementById("fv-model-badge").textContent =
    { "poisson": "Poisson", "empirical": "Empirical", "neg-binomial": "Neg-Binomial" }[fv.model] || fv.model;

  renderFVChart(fv);
  renderFVGrid(fv);
  renderTable(eps);

  document.getElementById("minute-panel").classList.remove("visible");
  if (minuteChart) { minuteChart.destroy(); minuteChart = null; }
}

// â”€â”€ Trend chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrendChart(episodes) {
  const ctx = document.getElementById("trend-chart").getContext("2d");
  if (trendChart) trendChart.destroy();

  const eps    = [...episodes].reverse();
  const labels = eps.map(e => e.episode_number ? `#${e.episode_number}` : (e.episode_date || `ID${e.episode_id}`));
  const counts = eps.map(e => e.count);

  const avgsData = currentData.averages;
  const avgLines = [
    { label: "Last 1",   value: avgsData.last_1,   color: "#ffffff" },
    { label: "Last 5",   value: avgsData.last_5,   color: "#00b4d8" },
    { label: "Last 20",  value: avgsData.last_20,  color: "#90e0ef" },
    { label: "Last 50",  value: avgsData.last_50,  color: "#ffd166" },
    { label: "Last 100", value: avgsData.last_100, color: "#06d6a0" },
  ].filter(a => a.value !== null && a.value !== undefined);

  const datasets = [
    {
      label: "Mentions",
      data: counts,
      backgroundColor: counts.map(c => c > 0 ? "#e94560cc" : "#2a2a4a"),
      borderColor: counts.map(c => c > 0 ? "#e94560" : "#2a2a4a"),
      borderWidth: 1, borderRadius: 3, type: "bar", order: 2,
    },
    ...avgLines.map(a => ({
      label: `${a.label} avg: ${a.value.toFixed(2)}`,
      data: Array(eps.length).fill(a.value),
      borderColor: a.color, borderWidth: 1.5, borderDash: [4, 4],
      pointRadius: 0, type: "line", order: 1,
    }))
  ];

  trendChart = new Chart(ctx, {
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { labels: { color: "#aaa", font: { size: 11 }, boxWidth: 18, padding: 10 }, position: "top" },
        tooltip: { callbacks: { title: items => { const i = items[0].dataIndex; return eps[i].title?.slice(0,50) || labels[i]; } } }
      },
      scales: {
        x: { ticks: { color: "#888", maxRotation: 45, font: { size: 10 }, maxTicksLimit: 25 }, grid: { color: "#22223a" } },
        y: { ticks: { color: "#888" }, grid: { color: "#22223a" }, beginAtZero: true }
      }
    }
  });
}

// â”€â”€ Fair-value chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFVChart(fv) {
  const ctx = document.getElementById("fv-chart").getContext("2d");
  if (fvChart) fvChart.destroy();

  const labels = fv.buckets.map(b => b.label);
  const pcts   = fv.buckets.map(b => b.pct);
  const colors = fv.buckets.map(() => "#e94560cc");

  fvChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "P(â‰¥ N) %", data: pcts, backgroundColor: colors, borderColor: colors.map(c => c.replace("cc","")), borderWidth: 1, borderRadius: 4 }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: { duration: 300 },
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: item => `P(â‰¥${item.label}) = ${item.raw.toFixed(1)}%` } } },
      scales: {
        x: { ticks: { color: "#888" }, grid: { color: "#22223a" } },
        y: { ticks: { color: "#888", callback: v => v + "%" }, grid: { color: "#22223a" }, beginAtZero: true, max: 100 }
      }
    }
  });
}

// â”€â”€ FV grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFVGrid(fv) {
  document.getElementById("fv-grid").innerHTML = fv.buckets.map(b => {
    const pct = b.pct;
    const cls = pct >= 30 ? "high" : pct >= 10 ? "medium" : "low";
    return `<div class="fv-cell">
      <div class="fv-n">â‰¥ ${b.label} mention${b.n !== 1 ? "s" : ""}</div>
      <div class="fv-pct ${cls}">${pct.toFixed(1)}%</div>
      <div class="fv-label">P(mentions â‰¥ ${b.label})</div>
    </div>`;
  }).join("");
}

// â”€â”€ Episode table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(episodes) {
  const tbody = document.getElementById("ep-tbody");
  tbody.innerHTML = episodes.map(ep => {
    const num   = ep.episode_number ? `#${ep.episode_number}` : `ID${ep.episode_id}`;
    const badge = ep.count > 0
      ? `<span class="count-badge">${ep.count}</span>`
      : `<span class="count-badge zero">0</span>`;
    const pm    = ep.per_minute > 0 ? `<span class="per-min">${ep.per_minute.toFixed(3)}/min</span>` : "";
    const title = (ep.title || "").slice(0, 55) + ((ep.title || "").length > 55 ? "â€¦" : "");
    return `<tr data-eid="${ep.episode_id}">
      <td class="ep-num">${num}</td>
      <td>${ep.episode_date || "â€”"}</td>
      <td>${badge}</td>
      <td>${pm}</td>
      <td>${escHtml(title)}</td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("tr").forEach(row => {
    row.addEventListener("click", () => {
      tbody.querySelectorAll("tr").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      loadMinutes(parseInt(row.dataset.eid));
    });
  });
}

// â”€â”€ Per-minute breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMinutes(episodeId) {
  if (!currentKeyword) return;
  try {
    const r = await fetch(`/api/minutes?keyword=${encodeURIComponent(currentKeyword)}&episode_id=${episodeId}`);
    const d = await r.json();

    const panel = document.getElementById("minute-panel");
    panel.classList.add("visible");
    document.getElementById("minute-title").textContent =
      `Per-minute â€” ${(d.title || String(episodeId)).slice(0, 60)}`;

    const ctx = document.getElementById("minute-chart").getContext("2d");
    if (minuteChart) minuteChart.destroy();

    if (!d.minutes || d.minutes.length === 0) {
      panel.querySelector("canvas").style.display = "none";
      document.getElementById("minute-title").textContent += "  (no mentions)";
      return;
    }
    panel.querySelector("canvas").style.display = "";

    const labels = d.minutes.map(m => `${m.minute}m`);
    const counts = d.minutes.map(m => m.count);
    const mean   = counts.reduce((a, b) => a + b, 0) / counts.length;

    minuteChart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [
        { label: "Mentions", data: counts, backgroundColor: "#e94560cc", borderColor: "#e94560", borderWidth: 1, borderRadius: 3, order: 2 },
        { label: `Avg ${mean.toFixed(2)}/min`, data: Array(counts.length).fill(mean), type: "line", borderColor: "#ffd166", borderWidth: 1.5, borderDash: [4,4], pointRadius: 0, order: 1 }
      ]},
      options: {
        responsive: true, maintainAspectRatio: false, animation: { duration: 200 },
        plugins: { legend: { labels: { color: "#aaa", font: { size: 10 }, boxWidth: 14 } } },
        scales: {
          x: { ticks: { color: "#888", font: { size: 10 }, maxTicksLimit: 30 }, grid: { color: "#22223a" } },
          y: { ticks: { color: "#888" }, grid: { color: "#22223a" }, beginAtZero: true }
        }
      }
    });

    panel.scrollIntoView({ behavior: "smooth", block: "start" });
  } catch (e) {
    toast("Could not load per-minute data", "error");
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v) {
  if (v === null || v === undefined) return "â€”";
  return Number(v).toFixed(2);
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function toast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = `toast${type ? " " + type : ""}`;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove("show"), 3200);
}
</script>
</body>
</html>
