<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JRE Keyword Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:       #0d0d1a;
  --surface:  #16213e;
  --card:     #1a1a2e;
  --border:   #2a2a4a;
  --accent:   #e94560;
  --accent2:  #00b4d8;
  --gold:     #ffd166;
  --green:    #06d6a0;
  --text:     #e8e8f0;
  --muted:    #888899;
  --radius:   10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app { display: flex; flex-direction: column; min-height: 100vh; }

header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.logo { font-size: 1.3rem; font-weight: 700; color: var(--accent); white-space: nowrap; }
.logo span { color: var(--text); }

.search-bar {
  display: flex;
  flex: 1;
  min-width: 260px;
  gap: 8px;
}
.search-bar input {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 16px;
  color: var(--text);
  font-size: 1rem;
  outline: none;
  transition: border-color .2s;
}
.search-bar input:focus { border-color: var(--accent2); }
.search-bar input::placeholder { color: var(--muted); }

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  font-size: .9rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity: .4; cursor: default; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-blue { background: var(--accent2); color: #000; }

.header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--muted);
  display: inline-block;
}
.status-dot.ok    { background: var(--green); }
.status-dot.busy  { background: var(--gold); animation: pulse 1s infinite; }
.status-dot.error { background: var(--accent); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

.status-text { font-size: .8rem; color: var(--muted); }

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
main { flex: 1; padding: 24px; max-width: 1400px; margin: 0 auto; width: 100%; }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}
.card-title {
  font-size: .85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
  margin-bottom: 16px;
}

/* ‚îÄ‚îÄ Stats row ‚îÄ‚îÄ */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  text-align: center;
}
.stat-val { font-size: 1.8rem; font-weight: 700; color: var(--accent); }
.stat-val.blue  { color: var(--accent2); }
.stat-val.gold  { color: var(--gold); }
.stat-val.green { color: var(--green); }
.stat-label { font-size: .75rem; color: var(--muted); margin-top: 4px; }

/* ‚îÄ‚îÄ Averages row ‚îÄ‚îÄ */
.avgs-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.avg-pill {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: .82rem;
  display: flex;
  align-items: center;
  gap: 6px;
}
.avg-pill .n  { color: var(--muted); }
.avg-pill .v  { font-weight: 700; }
.avg-pill .ci { color: var(--muted); font-size: .75rem; }
.avg-pill.ep1   .v { color: #fff; }
.avg-pill.ep5   .v { color: var(--accent2); }
.avg-pill.ep20  .v { color: #90e0ef; }
.avg-pill.ep50  .v { color: var(--gold); }
.avg-pill.ep100 .v { color: var(--green); }

/* ‚îÄ‚îÄ Charts grid ‚îÄ‚îÄ */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
.chart-wrap { position: relative; height: 280px; }

/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .85rem; }
thead th {
  background: var(--surface);
  padding: 10px 12px;
  text-align: left;
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background .1s;
}
tbody tr:hover { background: var(--surface); }
tbody tr.selected { background: #1e1e3a; }
tbody td { padding: 9px 12px; }
.count-badge {
  display: inline-block;
  background: var(--accent);
  color: #fff;
  border-radius: 4px;
  padding: 1px 7px;
  font-weight: 700;
  font-size: .82rem;
  min-width: 24px;
  text-align: center;
}
.count-badge.zero { background: var(--border); color: var(--muted); }
.ep-num { color: var(--accent2); font-weight: 600; }
.per-min { color: var(--muted); font-size: .8rem; }

/* ‚îÄ‚îÄ Fair value table ‚îÄ‚îÄ */
.fv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
.fv-cell {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  text-align: center;
  transition: border-color .15s, transform .1s;
  cursor: default;
}
.fv-cell:hover { border-color: var(--accent2); transform: translateY(-2px); }
.fv-n { font-size: .75rem; color: var(--muted); margin-bottom: 4px; }
.fv-pct { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
.fv-pct.high   { color: var(--accent); }
.fv-pct.medium { color: var(--gold); }
.fv-pct.low    { color: var(--muted); }
.fv-label { font-size: .7rem; color: var(--muted); margin-top: 3px; }
.fv-model-badge {
  display: inline-block;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: .75rem;
  color: var(--accent2);
  margin-bottom: 14px;
}

/* ‚îÄ‚îÄ Per-minute panel ‚îÄ‚îÄ */
#minute-panel { display: none; }
#minute-panel.visible { display: block; }

/* ‚îÄ‚îÄ Empty / loading states ‚îÄ‚îÄ */
.empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}
.empty .icon { font-size: 3rem; margin-bottom: 12px; }
.spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent2);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ Sync modal ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  display: none;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px 32px;
  width: 380px;
  max-width: 95vw;
}
.modal h2 { margin-bottom: 16px; font-size: 1.1rem; }
.modal p { color: var(--muted); font-size: .9rem; margin-bottom: 20px; }
.modal label { display: block; font-size: .85rem; color: var(--muted); margin-bottom: 6px; }
.modal input[type=number] {
  width: 100%;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 9px 12px;
  color: var(--text);
  font-size: 1rem;
  margin-bottom: 20px;
  outline: none;
}
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* ‚îÄ‚îÄ Lookback selector ‚îÄ‚îÄ */
.lookback-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.lookback-row label { font-size: .82rem; color: var(--muted); }
.lookback-row select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 5px 10px;
  font-size: .85rem;
  outline: none;
  cursor: pointer;
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 20px;
  font-size: .9rem;
  z-index: 200;
  transform: translateY(80px);
  opacity: 0;
  transition: all .3s;
  max-width: 320px;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error   { border-color: var(--accent); color: var(--accent); }

/* ‚îÄ‚îÄ No-data landing ‚îÄ‚îÄ */
#landing { display: none; }
#landing.visible { display: block; }
#results { display: none; }
#results.visible { display: block; }
</style>
</head>
<body>
<div class="app">

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<header>
  <div class="logo">JRE <span>Keyword Analyzer</span></div>

  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search keyword‚Ä¶ e.g. DMT, aliens, Trump" autocomplete="off"/>
    <button class="btn btn-primary" id="search-btn">Search</button>
  </div>

  <div class="header-actions">
    <span class="status-dot" id="status-dot"></span>
    <span class="status-text" id="status-text">Loading‚Ä¶</span>
    <button class="btn btn-blue" id="sync-btn">Sync YouTube</button>
  </div>
</header>

<!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
<main>

  <!-- Landing (empty DB) -->
  <div id="landing">
    <div class="empty">
      <div class="icon">üéôÔ∏è</div>
      <h2 style="margin-bottom:10px">No episodes loaded yet</h2>
      <p style="color:var(--muted);margin-bottom:24px">
        Sync real JRE transcripts from YouTube to get started.
      </p>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-blue" id="landing-sync-btn">Sync from YouTube</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="results">

    <!-- Stats row -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-val" id="stat-total">‚Äì</div>
        <div class="stat-label">Total mentions</div>
      </div>
      <div class="stat-card">
        <div class="stat-val blue" id="stat-episodes">‚Äì</div>
        <div class="stat-label">Episodes with data</div>
      </div>
      <div class="stat-card">
        <div class="stat-val gold" id="stat-avg1">‚Äì</div>
        <div class="stat-label">Avg last episode</div>
      </div>
      <div class="stat-card">
        <div class="stat-val green" id="stat-avg20">‚Äì</div>
        <div class="stat-label">Avg last 20 eps</div>
      </div>
    </div>

    <!-- Averages pills -->
    <div class="avgs-row" id="avgs-row"></div>

    <!-- Charts grid -->
    <div class="charts-grid">
      <div class="card">
        <div class="card-title">Mentions per episode</div>
        <div class="chart-wrap"><canvas id="trend-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Polymarket fair value ‚Äî next episode</div>
        <div class="lookback-row">
          <label>Lookback:</label>
          <select id="lookback-sel">
            <option value="5">Last 5</option>
            <option value="10">Last 10</option>
            <option value="20" selected>Last 20</option>
            <option value="50">Last 50</option>
            <option value="100">Last 100</option>
          </select>
          <span id="fv-model-badge" class="fv-model-badge"></span>
        </div>
        <div class="chart-wrap"><canvas id="fv-chart"></canvas></div>
      </div>
    </div>

    <!-- Fair value grid -->
    <div class="card">
      <div class="card-title">Fair value ‚Äî P(‚â• N mentions) in next episode</div>
      <div id="fv-lambda-ci" style="font-size:.8rem;color:var(--muted);margin-bottom:12px"></div>
      <div class="fv-grid" id="fv-grid"></div>
    </div>

    <!-- Per-minute panel -->
    <div class="card" id="minute-panel">
      <div class="card-title" id="minute-title">Per-minute breakdown</div>
      <div class="chart-wrap" style="height:220px"><canvas id="minute-chart"></canvas></div>
    </div>

    <!-- Episode table -->
    <div class="card">
      <div class="card-title">Episode history ‚Äî click a row for per-minute view</div>
      <div class="table-wrap">
        <table id="ep-table">
          <thead>
            <tr>
              <th>Episode</th>
              <th>Date</th>
              <th>Mentions</th>
              <th>95% CI (Joe-only)</th>
              <th>Per min</th>
              <th>Title</th>
            </tr>
          </thead>
          <tbody id="ep-tbody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /results -->
</main>
</div>

<!-- ‚îÄ‚îÄ Sync Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="sync-modal">
  <div class="modal">
    <h2>Sync from YouTube</h2>
    <p>Fetches the latest JRE episode list and downloads transcripts from the PowerfulJRE channel. This may take several minutes.</p>
    <label>Number of episodes to fetch</label>
    <input type="number" id="sync-n" value="100" min="1" max="500"/>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="sync-cancel">Cancel</button>
      <button class="btn btn-blue" id="sync-start">Start Sync</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Toast ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// State
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentKeyword  = "";
let currentData     = null;       // last /api/search response
let trendChart      = null;
let fvChart         = null;
let minuteChart     = null;
let statusInterval  = null;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Boot
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener("DOMContentLoaded", () => {
  refreshStatus();
  statusInterval = setInterval(refreshStatus, 4000);

  // Search
  document.getElementById("search-btn").addEventListener("click", doSearch);
  document.getElementById("search-input").addEventListener("keydown", e => {
    if (e.key === "Enter") doSearch();
  });

  // Sync
  document.getElementById("sync-btn").addEventListener("click", () => openSyncModal());
  document.getElementById("landing-sync-btn").addEventListener("click", () => openSyncModal());
  document.getElementById("sync-cancel").addEventListener("click", closeSyncModal);
  document.getElementById("sync-start").addEventListener("click", startSync);

  // Lookback change
  document.getElementById("lookback-sel").addEventListener("change", () => {
    if (currentKeyword) doSearch();
  });
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Status polling
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshStatus() {
  try {
    const r = await fetch("/api/status");
    const d = await r.json();
    const dot  = document.getElementById("status-dot");
    const txt  = document.getElementById("status-text");

    if (d.sync.running) {
      dot.className = "status-dot busy";
      txt.textContent = d.sync.message;
    } else if (d.total_episodes > 0) {
      dot.className = "status-dot ok";
      txt.textContent = `${d.total_episodes} episodes  |  ${d.latest_date || ""}`;
      showContent(d.total_episodes > 0);
    } else {
      dot.className = "status-dot";
      txt.textContent = "No episodes loaded";
      showContent(false);
    }
  } catch {
    document.getElementById("status-dot").className = "status-dot error";
    document.getElementById("status-text").textContent = "Server unreachable";
  }
}

function showContent(hasData) {
  document.getElementById("landing").classList.toggle("visible", !hasData);
  // Don't hide results if a search was already done
  if (!hasData) {
    document.getElementById("results").classList.remove("visible");
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Sync modal
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSyncModal()  { document.getElementById("sync-modal").classList.add("open"); }
function closeSyncModal() { document.getElementById("sync-modal").classList.remove("open"); }

async function startSync() {
  const n = parseInt(document.getElementById("sync-n").value) || 100;
  closeSyncModal();
  try {
    await fetch("/api/sync", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ episodes: n })
    });
    toast("Sync started ‚Äî check status bar", "success");
    refreshStatus();
  } catch {
    toast("Failed to start sync", "error");
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Search
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSearch() {
  const kw = document.getElementById("search-input").value.trim();
  if (!kw) { toast("Enter a keyword first", "error"); return; }

  const lookback = document.getElementById("lookback-sel").value;
  currentKeyword = kw;

  document.getElementById("search-btn").disabled = true;
  document.getElementById("search-btn").textContent = "Searching‚Ä¶";

  try {
    const r = await fetch(`/api/search?keyword=${encodeURIComponent(kw)}&lookback=${lookback}`);
    if (!r.ok) { const e = await r.json(); throw new Error(e.error || r.statusText); }
    const data = await r.json();
    currentData = data;
    renderResults(data);
    document.getElementById("results").classList.add("visible");
    document.getElementById("landing").classList.remove("visible");
  } catch (e) {
    toast(e.message, "error");
  } finally {
    document.getElementById("search-btn").disabled = false;
    document.getElementById("search-btn").textContent = "Search";
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Render
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults(data) {
  const eps   = data.episodes;
  const avgs  = data.averages;
  const fv    = data.fair_value;

  // Stats
  const total = eps.reduce((s, e) => s + e.count, 0);
  document.getElementById("stat-total").textContent    = total;
  document.getElementById("stat-episodes").textContent = eps.length;
  document.getElementById("stat-avg1").textContent     = fmt(avgs.last_1);
  document.getElementById("stat-avg20").textContent    = fmt(avgs.last_20);

  // Average pills with 95 % CI
  const pillDefs = [
    {cls:"ep1",   n:"Last 1",   v: avgs.last_1,   lo: avgs.last_1_lo,   hi: avgs.last_1_hi},
    {cls:"ep5",   n:"Last 5",   v: avgs.last_5,   lo: avgs.last_5_lo,   hi: avgs.last_5_hi},
    {cls:"ep20",  n:"Last 20",  v: avgs.last_20,  lo: avgs.last_20_lo,  hi: avgs.last_20_hi},
    {cls:"ep50",  n:"Last 50",  v: avgs.last_50,  lo: avgs.last_50_lo,  hi: avgs.last_50_hi},
    {cls:"ep100", n:"Last 100", v: avgs.last_100, lo: avgs.last_100_lo, hi: avgs.last_100_hi},
  ];
  document.getElementById("avgs-row").innerHTML = pillDefs.map(p => {
    const ciStr = (p.lo != null && p.hi != null)
      ? `<span class="ci">[${p.lo.toFixed(1)}‚Äì${p.hi.toFixed(1)}]</span>`
      : "";
    return `<div class="avg-pill ${p.cls}">
       <span class="n">${p.n}:</span>
       <span class="v">${fmt(p.v)}</span>
       ${ciStr}
     </div>`;
  }).join("");

  // Trend chart
  renderTrendChart(eps);

  // FV model badge
  document.getElementById("fv-model-badge").textContent =
    { "poisson": "Poisson", "empirical": "Empirical", "neg-binomial": "Neg-Binomial" }[fv.model] || fv.model;

  // Œª CI note (speaker-filter corrected)
  if (fv.lambda_ci_lo != null && fv.lambda_ci_hi != null) {
    document.getElementById("fv-lambda-ci").textContent =
      `Œª = ${fv.lambda.toFixed(2)}  |  95 % CI on true Joe count: [${fv.lambda_ci_lo.toFixed(2)}, ${fv.lambda_ci_hi.toFixed(2)}]  (¬±35 % speaker-filter uncertainty)`;
  }

  // FV chart
  renderFVChart(fv);

  // FV grid
  renderFVGrid(fv);

  // Episode table
  renderTable(eps);

  // Hide minute panel
  document.getElementById("minute-panel").classList.remove("visible");
  if (minuteChart) { minuteChart.destroy(); minuteChart = null; }
}

// ‚îÄ‚îÄ Trend chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTrendChart(episodes) {
  const ctx = document.getElementById("trend-chart").getContext("2d");
  if (trendChart) trendChart.destroy();

  // Oldest ‚Üí newest
  const eps    = [...episodes].reverse();
  const labels = eps.map(e => e.episode_number ? `#${e.episode_number}` : (e.upload_date || e.video_id.slice(0,6)));
  const counts = eps.map(e => e.count);

  // Average lines (horizontal)
  const avgsData = currentData.averages;
  const avgLines = [
    { label: "Last 1",   value: avgsData.last_1,   color: "#ffffff" },
    { label: "Last 5",   value: avgsData.last_5,   color: "#00b4d8" },
    { label: "Last 20",  value: avgsData.last_20,  color: "#90e0ef" },
    { label: "Last 50",  value: avgsData.last_50,  color: "#ffd166" },
    { label: "Last 100", value: avgsData.last_100, color: "#06d6a0" },
  ].filter(a => a.value !== null && a.value !== undefined);

  const datasets = [
    {
      label: "Mentions",
      data: counts,
      backgroundColor: counts.map(c => c > 0 ? "#e94560cc" : "#2a2a4a"),
      borderColor: counts.map(c => c > 0 ? "#e94560" : "#2a2a4a"),
      borderWidth: 1,
      borderRadius: 3,
      type: "bar",
      order: 2,
    },
    ...avgLines.map(a => ({
      label: `${a.label} avg: ${a.value.toFixed(2)}`,
      data: Array(eps.length).fill(a.value),
      borderColor: a.color,
      borderWidth: 1.5,
      borderDash: [4, 4],
      pointRadius: 0,
      type: "line",
      order: 1,
    }))
  ];

  trendChart = new Chart(ctx, {
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: {
          labels: { color: "#aaa", font: { size: 11 }, boxWidth: 18, padding: 10 },
          position: "top",
        },
        tooltip: {
          callbacks: {
            title: items => {
              const i = items[0].dataIndex;
              const ep = eps[i];
              return ep.title ? ep.title.slice(0, 50) : labels[i];
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: "#888",
            maxRotation: 45,
            font: { size: 10 },
            maxTicksLimit: 25,
          },
          grid: { color: "#22223a" },
        },
        y: {
          ticks: { color: "#888" },
          grid: { color: "#22223a" },
          beginAtZero: true,
        }
      }
    }
  });
}

// ‚îÄ‚îÄ Fair-value chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFVChart(fv) {
  const ctx = document.getElementById("fv-chart").getContext("2d");
  if (fvChart) fvChart.destroy();

  const labels = fv.buckets.map(b => b.label);
  const pcts   = fv.buckets.map(b => b.pct);
  const colors = fv.buckets.map(b => b.n === 0 ? "#0f3460" : "#e94560cc");

  fvChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "P(‚â• N) %",
        data: pcts,
        backgroundColor: colors,
        borderColor: colors.map(c => c.replace("cc", "")),
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: item => `P(‚â•${item.label}) = ${item.raw.toFixed(1)}%`
          }
        }
      },
      scales: {
        x: { ticks: { color: "#888" }, grid: { color: "#22223a" } },
        y: {
          ticks: { color: "#888", callback: v => v + "%" },
          grid: { color: "#22223a" },
          beginAtZero: true,
          max: 100,
        }
      }
    }
  });
}

// ‚îÄ‚îÄ FV grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFVGrid(fv) {
  const el = document.getElementById("fv-grid");
  el.innerHTML = fv.buckets.map(b => {
    const pct = b.pct;
    const cls = pct >= 30 ? "high" : pct >= 10 ? "medium" : "low";
    return `<div class="fv-cell">
      <div class="fv-n">‚â• ${b.label} mention${b.n !== 1 ? "s" : ""}</div>
      <div class="fv-pct ${cls}">${pct.toFixed(1)}%</div>
      <div class="fv-label">P(mentions ‚â• ${b.label})</div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ Episode table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable(episodes) {
  const tbody = document.getElementById("ep-tbody");
  tbody.innerHTML = episodes.map(ep => {
    const num   = ep.episode_number ? `#${ep.episode_number}` : ep.video_id.slice(0, 8);
    const badge = ep.count > 0
      ? `<span class="count-badge">${ep.count}</span>`
      : `<span class="count-badge zero">0</span>`;
    const ci = (ep.count_lo != null && ep.count_hi != null)
      ? `<span class="per-min">[${ep.count_lo.toFixed(1)}‚Äì${ep.count_hi.toFixed(1)}]</span>`
      : "‚Äî";
    const pm    = ep.per_minute > 0 ? `<span class="per-min">${ep.per_minute.toFixed(3)}/min</span>` : "";
    const title = (ep.title || "").slice(0, 55) + ((ep.title || "").length > 55 ? "‚Ä¶" : "");
    return `<tr data-vid="${ep.video_id}">
      <td class="ep-num">${num}</td>
      <td>${ep.upload_date || "‚Äî"}</td>
      <td>${badge}</td>
      <td>${ci}</td>
      <td>${pm}</td>
      <td>${title}</td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("tr").forEach(row => {
    row.addEventListener("click", () => {
      tbody.querySelectorAll("tr").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      loadMinutes(row.dataset.vid);
    });
  });
}

// ‚îÄ‚îÄ Per-minute breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMinutes(videoId) {
  if (!currentKeyword) return;
  try {
    const r = await fetch(`/api/minutes?keyword=${encodeURIComponent(currentKeyword)}&video_id=${encodeURIComponent(videoId)}`);
    const d = await r.json();

    const panel = document.getElementById("minute-panel");
    panel.classList.add("visible");

    document.getElementById("minute-title").textContent =
      `Per-minute ‚Äî ${(d.title || videoId).slice(0, 60)}`;

    const ctx = document.getElementById("minute-chart").getContext("2d");
    if (minuteChart) minuteChart.destroy();

    if (!d.minutes || d.minutes.length === 0) {
      panel.querySelector("canvas").style.display = "none";
      document.getElementById("minute-title").textContent += "  (no mentions)";
      return;
    }
    panel.querySelector("canvas").style.display = "";

    const labels = d.minutes.map(m => `${m.minute}m`);
    const counts = d.minutes.map(m => m.count);
    const mean   = counts.reduce((a, b) => a + b, 0) / counts.length;

    minuteChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Mentions",
            data: counts,
            backgroundColor: "#e94560cc",
            borderColor: "#e94560",
            borderWidth: 1,
            borderRadius: 3,
            order: 2,
          },
          {
            label: `Avg ${mean.toFixed(2)}/min`,
            data: Array(counts.length).fill(mean),
            type: "line",
            borderColor: "#ffd166",
            borderWidth: 1.5,
            borderDash: [4, 4],
            pointRadius: 0,
            order: 1,
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 200 },
        plugins: {
          legend: { labels: { color: "#aaa", font: { size: 10 }, boxWidth: 14 } }
        },
        scales: {
          x: {
            ticks: { color: "#888", font: { size: 10 }, maxTicksLimit: 30 },
            grid: { color: "#22223a" },
          },
          y: {
            ticks: { color: "#888" },
            grid: { color: "#22223a" },
            beginAtZero: true,
          }
        }
      }
    });

    // Scroll to panel
    panel.scrollIntoView({ behavior: "smooth", block: "start" });
  } catch (e) {
    toast("Could not load per-minute data", "error");
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Helpers
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(v) {
  if (v === null || v === undefined) return "‚Äî";
  return Number(v).toFixed(2);
}

function toast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = `toast${type ? " " + type : ""}`;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove("show"), 3200);
}
</script>
</body>
</html>
